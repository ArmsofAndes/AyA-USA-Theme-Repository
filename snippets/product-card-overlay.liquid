{%- comment -%}
  MODIFIED FOR OVERLAY & HOMEPAGE RULE:
  1. HTML structure changed for overlay layout (info inside figure).
  2. CSS added for the overlay effect.
  3. Image selection logic was replaced with the "homepage" alt text rule.
  4. Added data-cover + improved JS for restoring cover image when swatches unhover.
  5. Price was moved next to swatches inside product-card-swatches--container.
  6. MODIFIED: Swatch rendering logic moved here to limit swatches to 4 + show "+N".
  7. MODIFIED: Added CSS for Libre Baskerville font on price amount.
  8. MODIFIED: Color lookup now uses metafields like product-option.liquid
{%- endcomment -%}
{%- if product_card_product and product_card_product != empty -%}
{%- liquid
    assign products_hover_images = settings.products_hover_images
    assign products_hover_images_count = 0
    assign product_aspect_ratio = settings.product_aspect_ratio
    assign ratio = 1
    assign sizes = '375x375,770x770'
    assign is_video = false
    assign use_video = settings.products_use_video

    # --- START OF NEW HOMEPAGE IMAGE RULE ---
    assign featured_media = product_card_product.featured_media
    assign homepage_image = nil
    for image in product_card_product.images
      assign lower_alt = image.alt | default: '' | downcase
      if lower_alt contains 'homepage'
        assign homepage_image = image
        break
      endif
    endfor
    if homepage_image
      assign featured_media = homepage_image
    endif
    # --- END OF NEW HOMEPAGE IMAGE RULE ---

    if featured_media.media_type != blank and featured_media.media_type != 'image'
        if featured_media.media_type == 'video' and use_video
            assign is_video = true
        else
            assign featured_media = featured_media.preview_image
        endif
    endif

    # Buscar secondary hover image por keyword
    assign secondary_hover_media = nil
    if show_secondary_image and secondary_image and secondary_image != blank
      assign secondary_keyword_lower = secondary_image | downcase
      for image in product_card_product.images
        assign image_alt_lower = image.alt | default: '' | downcase
        if image_alt_lower contains secondary_keyword_lower
          assign secondary_hover_media = image
          break
        endif
      endfor
    endif

    assign sizes = '375x0,770x0'
    if product_aspect_ratio == 'adapt'
        if featured_media
            assign ratio = featured_media.aspect_ratio | default: 1
        endif
    elsif product_aspect_ratio == 'portrait'
        assign ratio = 1 | divided_by: 1.25
    elsif product_aspect_ratio == 'landscape'
        assign ratio = 1 | divided_by: 0.75
    endif
    assign product_content_alignment = settings.product_content_alignment

    assign is_purchasable = false
    if product_card_product.available and product_card_product.variants.size == 1
        assign is_purchasable = true
    endif

    assign show_size_options = settings.show_size_options
    assign size_options_variant_name = settings.size_options_variant_name
    assign size_options_limit = settings.size_options_limit

    assign product_image_fit = settings.product_image_fit
-%}
<product-card class="product-card product-card-overlay text-{{ product_content_alignment }}">
  <figure class="product-card--featured-image product-card--featured-image--{{ product_image_fit }} {% if products_hover_images and product_card_product.images.size > 1 and products_hover_images_count > 0 %}thb-hover{% endif %}">

    {% render 'product-card-badge', product_card_product: product_card_product %}
    {% for tag in product_card_product.tags %}
      {% if tag contains '%' %}
        <p class="budget-disscount budget-disscount-card">{{ tag }} OFF</p>
      {% endif %}
    {% endfor %}

    <a href="{{ product_card_product.url | within: collection }}" title="{{ product_card_product.title | escape }}" class="product-card--featured-image-link aspect-ratio aspect-ratio--{{ settings.product_aspect_ratio }}" style="--padding-bottom: {{ 1 | divided_by: ratio | times: 100 }}%;">

    {%- if secondary_hover_media -%}
      {%- render 'responsive-image',
        class: 'product-secondary-image',
        image: secondary_hover_media,
        sizes: sizes,
        priority: 'low',
        defer: true
      -%}
    {%- elsif products_hover_images and product_card_product.images.size > 1 -%}
      {%- for i in (1..products_hover_images_count) -%}
        {%- if product_card_product.images[i] -%}
          {%- render 'responsive-image', class: 'product-secondary-image', image: product_card_product.images[i], sizes: sizes, priority: 'low', defer: true -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}

      {%- if featured_media -%}
        {%- if is_video and use_video -%}
          {{ featured_media | video_tag: controls: false, loading: 'lazy', loop: true, autoplay: true, image_size: '770x' }}
        {%- else -%}
          {%- if featured_media.preview_image -%}
            {%- render 'responsive-image', class: 'product-primary-image', image: featured_media.preview_image, sizes: sizes, attributes: 'data-cover="true"' -%}
          {%- else -%}
            {%- render 'responsive-image', class: 'product-primary-image', image: featured_media, sizes: sizes, attributes: 'data-cover="true"' -%}
          {%- endif -%}
        {%- endif -%}
      {%- else -%}
        <div class="thb-placeholder">
          {{ 'product-1' | placeholder_svg_tag }}
        </div>
      {%- endif -%}
    </a>

    {%- if settings.enable_quick_view -%}
      <quick-view class="product-card-quickview product-card-quickview--{%- unless show_size_options -%}button{%- else -%}icon{%- endunless -%}" data-product-handle="{{ product_card_product.handle }}" tabindex="-1">
        <div class="loading-overlay">{% render 'svg-icons' with 'thb-loading' %}</div>
        <span>{%- unless show_size_options -%}{{ 'products.product.quick_view' | t }}{%- else -%}{% render 'svg-icons' with 'thb-quick-view' %}{%- endunless -%}</span>
      </quick-view>
    {%- endif -%}

    {%- if show_size_options -%}
      {%- render 'product-card-size-options', product_card_product: product_card_product -%}
    {%- endif -%}

    {%- if products_hover_images and product_card_product.images.size > 1 and settings.products_hover_dots -%}
      <ul class="product-secondary-images-nav">
        {%- for i in (1..products_hover_images_count) -%}
          {%- if product_card_product.images[i] -%}
            <li></li>
          {%- endif -%}
        {%- endfor -%}
      </ul>
    {%- endif -%}

    <div class="product-card-info">
        {%- if settings.show_products_vendor -%}
        <div class="product-card-vendor"><a href="{{ product_card_product.vendor | url_for_vendor }}" title="{{ product_card_product.vendor | escape }}">{{ product_card_product.vendor }}</a></div>
        {%- endif -%}

        <a href="{{ product_card_product.url | within: collection }}" title="{{ product_card_product.title | escape }}" class="product-card-title">{{ product_card_product.title }}</a>

        <div class="product-card-swatches--container">
          {%- comment -%} START: Swatch limit logic with metafield support {%- endcomment -%}
          {%- if settings.show_products_swatches -%}
            {%- assign swatch_style = settings.swatch_style -%}
            {%- unless product_card_product.has_only_default_variant -%}
              {%- for option in product_card_product.options_with_values -%}
                {%- liquid
                  assign option_name = option.name | downcase | escape
                  assign color_swatch = false

                  if option_name contains 'color' or option_name contains 'colour' or option_name contains 'couleur' or option_name contains 'farbe'
                    assign color_swatch = true
                  endif

                  assign color_swatches_variant_option = settings.color_swatches_variant_option | downcase | split: ', '

                  if color_swatches_variant_option contains option_name
                    assign color_swatch = true
                  endif
                -%}
                {%- if color_swatch -%}
                  {%- liquid
                    assign swatch_limit = 4
                    assign total_swatches = option.values.size
                    assign remaining_swatches = total_swatches | minus: swatch_limit
                    assign color_index = forloop.index0
                    assign custom_colors = settings.color_swatches | newline_to_br | split: '<br />'
                    assign key_array = ''
                    assign val_array = ''

                    for color in custom_colors
                      assign key = color | split: ':' | first | rstrip
                      assign value = color | split: ':' | last | lstrip
                      assign key_array = key_array | append: ',' | append: key
                      assign val_array = val_array | append: ',' | append: value
                    endfor

                    assign key_array = key_array | remove_first: ',' | strip_newlines | downcase | split: ','
                    assign val_array = val_array | remove_first: ',' | split: ','
                  -%}
                  {% if option.values.size > 1 %}
                    <div class="product-card-swatches--container no-js-hidden">
                      <div class="product-card-swatches product-card-swatches--{{ settings.swatch_style }}" data-index="{{ color_index }}">
                        {%- for value in option.values limit: swatch_limit -%}
                          {%- liquid
                            assign active = ''
                            assign variant_image = blank
                            assign variant_url = ''
                            assign srcset = ''

                            for variant in product_card_product.variants
                              if variant.options contains value
                                if variant.image.id and variant.image.id == featured_media.id
                                  assign active = 'active'
                                endif
                                if variant.image
                                  assign variant_image = variant.image
                                endif
                                assign variant_url = variant.url
                                break
                              endif
                            endfor
                            assign image_sizes = sizes | split: ","
                          -%}
                          {%- capture srcset -%}
                            {%- if variant_image != blank -%}
                              {%- for size in image_sizes -%}
                                {%- assign size_array = size | split: "x" -%}
                                {%- assign size_x = size_array[0] | append: 'x' -%}
                                {% if size_array[1] != "0" %}
                                  {%- assign size_x = size -%}
                                {% endif %}
                                {{- variant_image.src | img_url: size_x, crop: 'center' }} {{ size_array[0] }}w,
                              {%- endfor -%}
                            {%- endif -%}
                          {%- endcapture -%}
                          {% assign l = srcset | size | minus: 1 %}
                          
                          {%- comment -%} NEW: Check metafields first, like product-option.liquid {%- endcomment -%}
                          {%- liquid
                            assign color_value = blank
                            assign option_in_color_options = blank
                            
                            # Try to find color from metafields (variant_options_1, 2, or 3)
                            if product_card_product.metafields.custom.variant_options_1 != blank
                              assign option_in_color_options = product_card_product.metafields.custom.variant_options_1.value | find: 'label', value
                            endif
                            
                            if option_in_color_options == blank and product_card_product.metafields.custom.variant_options_2 != blank
                              assign option_in_color_options = product_card_product.metafields.custom.variant_options_2.value | find: 'label', value
                            endif
                            
                            if option_in_color_options == blank and product_card_product.metafields.custom.variant_options_3 != blank
                              assign option_in_color_options = product_card_product.metafields.custom.variant_options_3.value | find: 'label', value
                            endif
                            
                            # If found in metafield, use that color
                            if option_in_color_options != blank and option_in_color_options.color != blank
                              assign color_value = option_in_color_options.color | downcase | escape
                            else
                              # Fallback to value name
                              assign color_value = value | downcase | escape
                            endif
                            
                            # Check custom colors from settings
                            for custom_color in key_array
                              if custom_color == color_value
                                assign color_value = val_array[forloop.index0]
                              endif
                            endfor
                            
                            assign bg_value = ''
                            
                            # Check if it's a file
                            if color_value contains '.'
                              assign bg_value = color_value | file_url
                              assign color_value = 'var(--bg-body)'
                            endif
                            
                            # Check native Shopify swatches
                            if value.swatch.image
                              assign bg_value = value.swatch.image | image_url: width: 24
                            elsif value.swatch.color
                              assign color_value = 'rgb(' | append: value.swatch.color.rgb | append: ')'
                            endif
                          -%}
                          
                          <div class="product-card-swatch {{ active }}" style="--option-color: {{ color_value | downcase | escape }}; {%- if bg_value -%} --option-color-image: url('{{ bg_value | escape }}');{%- endif -%}" data-srcset="{{- srcset | slice: 0, l | strip_newlines -}}" data-href="{{ variant_url }}">
                            <span class="visually-hidden">
                              {{ value }}
                            </span>
                          </div>
                        {%- endfor -%}
                        {%- if remaining_swatches > 0 -%}
                          <a href="{{ product_card_product.url | within: collection }}" class="product-card-swatch-more" title="{{ 'products.product.view_all_colors' | t: count: total_swatches }}">
                            +{{- remaining_swatches -}}
                          </a>
                        {%- endif -%}
                      </div>
                      {%- if swatch_style == 'hover' -%}
                        <div class="product-card-swatches--title">{{ 'products.product.available' | t: count: option.values.size }}</div>
                      {%- endif -%}
                    </div>
                  {%- endif -%}
                  {% break %}
                {%- endif -%}
              {%- endfor -%}
            {%- endunless -%}
          {%- endif -%}
          {%- comment -%} END: Swatch limit logic {%- endcomment -%}
          {% render 'product-price', product: product_card_product %}
        </div>

        {%- if settings.show_products_rating and product_card_product.metafields.reviews.rating.value != blank -%}
          <div class="star-rating" style="--star-rating: {{ product_card_product.metafields.reviews.rating.value.rating }};"></div>
        {%- endif -%}

        {%- if settings.show_products_subtitle and product_card_product.metafields.descriptors.subtitle != blank -%}
          <p class="product-card-subtitle">{{ product_card_product.metafields.descriptors.subtitle }}</p>
        {%- endif -%}

        {%- if settings.enable_quick_add -%}
          {%- liquid
            assign button_tag = 'button'
            if product_card_product.selected_or_first_available_variant.available == false
              assign button_content = 'products.product.sold_out' | t
            else
              if product_card_product.metafields.theme.preorder and product_card_product.available
                assign button_content = 'products.product.pre_order' | t
              else
                if is_purchasable
                  assign button_content = 'products.product.add_to_cart' | t
                else
                  assign button_content = 'products.product.choose_options' | t
                endif
              endif
              unless is_purchasable
                assign button_tag = 'quick-view'
              endunless
            endif
          -%}
          <div class="product-card--add-to-cart-button-container">
            <{{ button_tag }} class="product-card--add-to-cart-button outline{% if is_purchasable %} product-card--add-to-cart-button-simple{% endif %} button accent" data-product-id="{{ product_card_product.selected_or_first_available_variant.id }}" data-product-handle="{{ product_card_product.handle }}" tabindex="-1" {% if product_card_product.selected_or_first_available_variant.available == false %}disabled{% endif %}>
              <span class="loading-overlay">{% render 'svg-icons' with 'thb-loading' %}</span>
              <span class="product-card--add-to-cart-text">{{ button_content }}</span>
            </{{ button_tag }}>
          </div>
        {%- endif -%}
    </div>
  </figure>
</product-card>
{%- else -%}
{%- endif -%}

<style>
  .budget-disscount {
    background-color: #f44336;
    color: white;
    font-size: 0.75rem;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
    position: absolute;
    bottom: 3px;
    left: 8px;
    z-index: 10;
  }
  .budget-disscount-card {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
  .product-secondary-image {
    position: absolute;
    top: 0;
    left: 0;
    opacity: 0;
    transition: opacity .3s ease;
    z-index: 3;
  }
  .product-card:hover .product-secondary-image {
    opacity: 1;
  }
  .product-card--featured-image {
    position: relative;
    display: block;
  }
  .product-card-info {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    z-index: 5;
    padding: 15px;
    color: white;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.75), transparent);
    transition: opacity 0.3s ease-in-out;
  }
  .product-card-info .product-card-title,
  .product-card-info .price,
  .product-card-info .price--on-sale .price-item--regular {
    color: white;
  }
  .product-card-swatches--container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: nowrap; /* Changed to prevent wrapping */
    margin-top: 0px!important;
  }
  .product-card-swatches--container .price {
    margin: 0;
    font-size: 0.9rem;
    font-weight: 600;
    flex-shrink: 0; /* Prevents price from shrinking */
  }
  /* START: New rule for the price font */
  .price .amount {
    font-family: 'Libre Baskerville', serif;
  }
  /* END: New rule */
  .product-card-swatches {
    display: flex;
    align-items: center;
    gap: 5px; /* Adjust gap between swatches */
  }
  .product-card-swatch-more {
    font-size: 0.8rem;
    font-weight: 500;
    color: white;
    text-decoration: none;
    line-height: 1;
    padding-left: 2px;
  }
  .product-card-swatches--container:not(:has(.product-card-swatches)) {
  justify-content: flex-end;
}
</style>

<script>
(function(){
  function parseFirstUrl(srcset) {
    if (!srcset) return null;
    var parts = srcset.split(',');
    if (!parts || parts.length === 0) return null;
    var first = parts[0].trim().split(/\s+/)[0];
    return first || null;
  }

  function setImgSrcAndSrcset(img, srcset, firstUrl) {
    if (!img) return;
    try {
      if (srcset !== null) {
        img.setAttribute('srcset', srcset);
      } else {
        img.removeAttribute('srcset');
      }
      if (firstUrl) {
        img.src = firstUrl;
      }
    } catch (e) {}
    var picture = img.closest('picture');
    if (picture) {
      var sources = picture.querySelectorAll('source');
      sources.forEach(function(source){
        if (srcset !== null) source.setAttribute('srcset', srcset);
        else source.removeAttribute('srcset');
      });
    }
  }

  function initCard(card) {
    var primaryEl = card.querySelector('.product-primary-image');
    var img = null;

    if (primaryEl) {
      if (primaryEl.tagName && primaryEl.tagName.toLowerCase() === 'img') {
        img = primaryEl;
      } else {
        img = primaryEl.querySelector('img') || card.querySelector('img');
      }
    } else {
      img = card.querySelector('img');
    }

    if (!img) return;

    var originalSrcset = img.getAttribute('srcset');
    var originalSrc = img.src;

    var picture = img.closest('picture');
    var originalSources = [];
    if (picture) {
      picture.querySelectorAll('source').forEach(function(s){
        originalSources.push(s.getAttribute('srcset'));
      });
    }

    var swatches = card.querySelectorAll('.product-card-swatch');
    if (!swatches || swatches.length === 0) return;

    function restore() {
      setImgSrcAndSrcset(img, originalSrcset, originalSrc);
      if (picture && originalSources.length) {
        var sources = picture.querySelectorAll('source');
        sources.forEach(function(s, idx){
          var val = originalSources[idx] || null;
          if (val) s.setAttribute('srcset', val);
          else s.removeAttribute('srcset');
        });
      }
    }

    swatches.forEach(function(swatch){
      swatch.addEventListener('mouseenter', function(){
        var srcset = swatch.dataset.srcset || null;
        var firstUrl = parseFirstUrl(srcset);
        if (srcset) {
          setImgSrcAndSrcset(img, srcset, firstUrl);
        }
      });

      swatch.addEventListener('mouseleave', function(e){
        var related = e.relatedTarget;
        if (related && related.closest) {
          var relSw = related.closest('.product-card-swatch');
          if (relSw && card.contains(relSw)) {
            return;
          }
        }
        restore();
      });

      swatch.addEventListener('touchend', function(){
        setTimeout(restore, 100);
      });
      swatch.addEventListener('touchcancel', function(){
        setTimeout(restore, 100);
      });
    });

    var swatchesContainer = card.querySelector('.product-card-swatches');
    if (swatchesContainer) {
      swatchesContainer.addEventListener('mouseleave', restore);
    }
    card.addEventListener('mouseleave', restore);
  }

  function initAll() {
    document.querySelectorAll('.product-card-overlay').forEach(initCard);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAll);
  } else {
    initAll();
  }
})();
</script>