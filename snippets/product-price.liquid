{% comment %}
    Renders a list of product's price (regular, sale)
    Accepts:
    - product: {Object} Product Liquid object (required)
    - use_variant: {Boolean} Renders selected or first variant price instead of overall product pricing (optional)
    - price_class: {String} Adds a price class to the price element (optional)
    - show_badges: {Boolean} Renders badges (sale, out-of-stock, pre-order) next to the price (optional)
    - show_custom_badges: {Boolean} Renders custom badges based on product tags (optional)
    - current_collection_handle: {String} Collection handle for detecting collection-specific discounts (optional)
    - source_collection_handle: {String} Collection handle from user's origin to persist discount (optional)
    Usage:
    {% render 'product-price', product: product %}
{% endcomment %}
{%- liquid
	if use_variant
    assign target = product.selected_or_first_available_variant
  else
    assign target = product
  endif
  assign compare_at_price = target.compare_at_price
  assign price = target.price | default: 1999
	assign available = target.available | default: false

    
  assign money_price = price | money
  if settings.currency_code_enabled
    assign money_price = price | money_with_currency
  endif

    
	if target == product and product.price_varies
    assign money_price = 'products.product.price.from_price_html' | t: price: money_price
  endif

	assign discounted_class = ''
	unless product.price_varies == false and product.compare_at_price_varies
		if compare_at_price != null and compare_at_price != 0 and price != compare_at_price
			assign discounted_class = 'discounted'
		endif
	endunless
-%}
{%- comment %} 
  Sistema de descuentos basado en metafields
  
  Lógica según especificaciones:
  - discount_general_percent: Descuento para TODAS las páginas EXCEPTO para visitantes que vienen de discount_collection
  - discount_collection_percent: Porcentaje de descuento exclusivo para collections específicas
  - discount_collection: Lista de collections con descuento exclusivo
  
  Reglas:
  1. Si el usuario viene de una collection en discount_collection → aplicar discount_collection_percent (REEMPLAZA al general)
  2. Si NO viene de esa collection → aplicar discount_general_percent
  3. Si no hay descuentos configurados → precio normal
{%- endcomment -%}
{%- liquid
  # Leer metafields de descuento
  assign discount_general = product.metafields.custom.discount_general_percent.value | default: 0 | plus: 0
  assign discount_collection_percent = product.metafields.custom.discount_collection_percent.value | default: 0 | plus: 0
  assign discount_collections = product.metafields.custom.discount_collection.value

  # Detectar collection actual (prioridad: source_collection_handle > current_collection_handle)
  # source_collection_handle viene de product-information.liquid y persiste el origen del usuario
  # CRÍTICO: Si source_collection_handle está en blanco, el descuento exclusivo no se aplicará
  assign active_collection_handle = source_collection_handle
  if active_collection_handle == blank
    assign active_collection_handle = current_collection_handle
  endif

  # Verificar si la collection actual está en la lista de collections con descuento exclusivo
  # CRÍTICO: Esta verificación determina si se aplica el descuento exclusivo o el general
  assign is_collection_discount_active = false
  if discount_collections != blank and discount_collection_percent > 0 and active_collection_handle != blank
    assign active_handle_clean = active_collection_handle | strip
    for discount_collection in discount_collections
      assign collection_handle_clean = discount_collection.handle | strip
      if collection_handle_clean == active_handle_clean
        assign is_collection_discount_active = true
        break
      endif
    endfor
  endif

  # Aplicar lógica de prioridad según especificaciones:
  # 1. Si viene de collection exclusiva → aplicar discount_collection_percent (reemplaza general)
  # 2. Si NO viene de collection exclusiva → aplicar discount_general_percent
  assign discount_applied = false
  assign discount_percent = 0
  if is_collection_discount_active
    # Usuario viene de collection exclusiva → aplicar descuento exclusivo
    assign discount_percent = discount_collection_percent
    assign discount_applied = true
  elsif discount_general > 0
    # Usuario NO viene de collection exclusiva → aplicar descuento general
    assign discount_percent = discount_general
    assign discount_applied = true
  endif

  # Calcular precio con descuento si aplica
  # IMPORTANTE: Solo aplicar descuento de metafields si no hay compare_at_price nativo de Shopify
  # O si el descuento de metafield es diferente al descuento nativo
  assign original_price = target.price
  assign original_compare_at_price = target.compare_at_price
  
  # Verificar si hay un descuento nativo de Shopify
  assign has_native_discount = false
  if original_compare_at_price != null and original_compare_at_price > 0 and original_compare_at_price > original_price
    assign has_native_discount = true
  endif
  
  # Aplicar descuento de metafields solo si:
  # 1. Hay un descuento configurado en metafields
  # 2. Y no hay descuento nativo, O el descuento de metafield debe reemplazarlo
  if discount_applied and discount_percent > 0
    assign discount_amount = original_price | times: discount_percent | divided_by: 100
    assign discounted_price_raw = original_price | minus: discount_amount
    
    # Redondeo hacia arriba con último decimal en 0
    assign rounding_unit = 10
    assign remainder = discounted_price_raw | modulo: rounding_unit
    if remainder > 0
      assign discounted_price = discounted_price_raw | minus: remainder | plus: rounding_unit
    else
      assign discounted_price = discounted_price_raw
    endif
    
    # Aplicar descuento de metafield (reemplaza cualquier descuento nativo)
    assign price = discounted_price
    assign compare_at_price = original_price
    
    # Actualizar money_price con el nuevo precio
    assign money_price = price | money
    if settings.currency_code_enabled
      assign money_price = price | money_with_currency
    endif
  endif
-%}

<span class="price">
	{%- unless product.price_varies == false and product.compare_at_price_varies %}
		{% if compare_at_price != null and compare_at_price != 0 and price != compare_at_price %}
			<del>
				<span class="amount">
					{% if settings.currency_code_enabled %}
						{{ compare_at_price | money_with_currency }}
					{% else %}
						{{ compare_at_price | money }}
					{% endif %}
				</span>
			</del>
		{% endif %}
	{%- endunless -%}
	<ins><span class="amount {{ discounted_class }}">{{ money_price }}</span></ins>
	<small class="unit-price {% if product.selected_or_first_available_variant.unit_price_measurement == nil %} hidden{% endif %}">
		<span>{{- product.selected_or_first_available_variant.unit_price | money -}}</span>
    <span class="unit-price-separator">/</span>
		<span>
      {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
        {{- product.selected_or_first_available_variant.unit_price_measurement.reference_value -}}
      {%- endif -%}
      {{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit -}}
    </span>
	</small>
	{%- if show_badges -%}
		<span class="badges">
			{%- if compare_at_price > price %}
			{%- if settings.sale_badge_type == 'save_amount' -%}
				{%- capture saved_amount -%}{{ compare_at_price | minus: price | money }}{%- endcapture -%}
			{%- elsif settings.sale_badge_type == 'save_percentage' -%}
				{%- capture saved_amount -%}{{ compare_at_price | minus: price | times: 100.0 | divided_by: compare_at_price | round }}%{%- endcapture -%}
			{%- endif -%}
			<span class="badge onsale">
				{%- if settings.sale_badge_type == 'sale' -%}
				{{ 'products.product.on_sale' | t }}
				{%- else -%}
				{{ 'products.product.save_html' | t: saved_amount: saved_amount }}
				{%- endif -%}
		  </span>
			{% endif %}
			{%- if available == false -%}
		  <span class="badge out-of-stock">
		    {{ 'products.product.sold_out' | t }}
		  </span>
			{% endif %}
			{%- if product.metafields.theme.preorder and product.available -%}
			<span class="badge pre-order">
				{{ 'products.product.pre_order' | t }}
			</span>
			{%- endif -%}
			{%- if show_custom_badges -%}
				{%- liquid
					# Custom badges
					assign product_tags = product.tags
					assign badge_tags_1 = settings.custom_product_badge_group_1_tag_names | split: ', '
					assign badge_tags_2 = settings.custom_product_badge_group_2_tag_names | split: ', '
					assign badge_tags_3 = settings.custom_product_badge_group_3_tag_names | split: ', '
					assign badge_tags_4 = settings.custom_product_badge_group_4_tag_names | split: ', '
					assign badge_tags = badge_tags_1 | concat: badge_tags_2 | concat: badge_tags_3 | concat: badge_tags_4
				-%}
				{%- for badge_tag in badge_tags -%}
					{%- for product_tag in product_tags -%}
						{%- assign product_tag_lower = product_tag | downcase -%}
						{%- assign badge_tag_lower = badge_tag | downcase -%}
						{%- if product_tag_lower == badge_tag_lower -%}
							{%- capture custom_badges -%}
								{{ custom_badges }}
								<div class="badge {{ badge_tag_lower | handleize }}" data-badge="{{ badge_tag_lower | handleize }}">
									{{ badge_tag }}
								</div>
							{%- endcapture -%}
						{%- endif -%}
					{%- endfor -%}
				{%- endfor -%}
				{{ custom_badges }}
			{%- endif -%}
		</span>
	{% endif %}
</span>
