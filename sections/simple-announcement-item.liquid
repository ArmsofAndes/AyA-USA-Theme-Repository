{{ 'announcement-bar.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign enable_item = section.settings.enable_item
  assign text = section.settings.text
  assign link_url = section.settings.link_url
  assign link_label = section.settings.link_label
  assign icon = section.settings.icon
  assign background_color = section.settings.background_color | default: '#000000'
  assign text_color = section.settings.text_color | default: '#ffffff'
  assign font_size = section.settings.font_size | default: 13
  
  assign show_on_home = section.settings.show_on_home
  assign show_on_collection = section.settings.show_on_collection
  assign show_on_product = section.settings.show_on_product
  assign show_on_blog = section.settings.show_on_blog
  
  assign show_item = true
  
  if show_on_home == blank
    assign show_on_home = true
  endif
  if show_on_collection == blank
    assign show_on_collection = true
  endif
  if show_on_product == blank
    assign show_on_product = true
  endif
  if show_on_blog == blank
    assign show_on_blog = true
  endif
  
  if template == 'index'
    if show_on_home == false
      assign show_item = false
    endif
  elsif template.name == 'collection'
    if show_on_collection == false
      assign show_item = false
    endif
  elsif template.name == 'product'
    if show_on_product == false
      assign show_item = false
    endif
  elsif template.name == 'blog' or template.name == 'article'
    if show_on_blog == false
      assign show_item = false
    endif
  endif
  
  assign enable_sticky = section.settings.enable_sticky
  assign sticky_on_home = section.settings.sticky_on_home
  assign sticky_on_collection = section.settings.sticky_on_collection
  assign sticky_on_product = section.settings.sticky_on_product
  assign sticky_on_blog = section.settings.sticky_on_blog
  
  if sticky_on_home == blank
    assign sticky_on_home = true
  endif
  if sticky_on_collection == blank
    assign sticky_on_collection = true
  endif
  if sticky_on_product == blank
    assign sticky_on_product = true
  endif
  if sticky_on_blog == blank
    assign sticky_on_blog = true
  endif
  
  if enable_sticky
    if template == 'index'
      if sticky_on_home == false
        assign enable_sticky = false
      endif
    elsif template.name == 'collection'
      if sticky_on_collection == false
        assign enable_sticky = false
      endif
    elsif template.name == 'product'
      if sticky_on_product == false
        assign enable_sticky = false
      endif
    elsif template.name == 'blog' or template.name == 'article'
      if sticky_on_blog == false
        assign enable_sticky = false
      endif
    endif
  endif
-%}

{%- if enable_item and show_item -%}
<div id="shopify-section-{{ section.id }}" class="simple-announcement-item-section {% if enable_sticky %}sticky-enabled-section{% endif %}" style="--simple-announcement-bg: {{ background_color }}; --simple-announcement-text: {{ text_color }}; --simple-announcement-font-size: {{ font_size }}px;" data-no-inline-styles="true">
  <div class="simple-announcement-item" data-sticky-enabled="{{ enable_sticky }}">
    <div class="simple-announcement-item--inner">
      <div class="simple-announcement-item--content">
        {%- if icon != blank -%}
          {% render 'svg-icons-inline', icon: icon %}
        {%- endif -%}
        {%- if link_url != blank -%}
          <a href="{{ link_url }}" {% if link_label != blank %}aria-label="{{ link_label }}"{% endif %}>
            {{ text }}
          </a>
        {%- else -%}
          {{ text }}
        {%- endif -%}
      </div>
    </div>
  </div>
  
  <style>
    /* Estilos esenciales para simple-announcement-item */
    #shopify-section-{{ section.id }}.simple-announcement-item-section {
      margin: 0 !important;
      padding: 0 !important;
      border: none !important;
      background-color: var(--simple-announcement-bg, #000000) !important;
      color: var(--simple-announcement-text, #ffffff) !important;
    }
    
    #shopify-section-{{ section.id }}.simple-announcement-item-section.sticky-enabled-section {
      position: sticky !important;
      top: var(--simple-announcement-top, 0px) !important;
      z-index: 52 !important;
      width: 100% !important;
      left: 0 !important;
      right: 0 !important;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 42px;
      min-height: 42px;
      max-height: 42px;
      margin: 0;
      padding: 0;
      background-color: var(--simple-announcement-bg, #000000) !important;
      color: var(--simple-announcement-text, #ffffff) !important;
    }
    
    @media (max-width: 768px) {
      #shopify-section-{{ section.id }} .simple-announcement-item {
        height: 46px;
        min-height: 46px;
        max-height: 46px;
      }
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--inner {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0 15px;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--content {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
      padding: 0;
      font-size: var(--simple-announcement-font-size, 13px) !important;
      color: var(--simple-announcement-text, #ffffff) !important;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--content a {
      color: var(--simple-announcement-text, #ffffff) !important;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--content svg {
      margin: 0 8px 0 0;
      flex-shrink: 0;
      height: auto;
      width: auto;
      max-height: 18px;
      max-width: 18px;
      fill: currentColor !important;
      stroke: currentColor !important;
      color: var(--simple-announcement-text, #ffffff) !important;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item:hover,
    #shopify-section-{{ section.id }} .simple-announcement-item *:hover {
      transform: none !important;
      translate: none !important;
      box-shadow: none !important;
      cursor: default !important;
      background-color: var(--simple-announcement-bg, #000000) !important;
      color: var(--simple-announcement-text, #ffffff) !important;
    }
  </style>
  
  <script>
    (function() {
      const sectionId = 'shopify-section-{{ section.id }}';
      const specificSection = document.getElementById(sectionId);
      
      if (!specificSection) return;
      
      // Función para aplicar sticky y eliminar estilos inline
      function applyStickyAndCleanStyles() {
        const item = specificSection.querySelector('.simple-announcement-item');
        if (!item) return;
        
        const enableSticky = item.getAttribute('data-sticky-enabled') === 'true';
        
        if (enableSticky) {
          // Agregar clase sticky
          specificSection.classList.add('sticky-enabled-section');
          
          // Calcular top basado en otros elementos sticky
          const announcementBarTop = document.querySelector('.announcement-bar-top-section.sticky-enabled-section');
          let topValue = '0px';
          let totalHeight = 0;
          
          if (announcementBarTop && announcementBarTop !== specificSection) {
            const topHeight = announcementBarTop.offsetHeight || (window.matchMedia('(max-width: 767px)').matches ? 46 : 42);
            totalHeight += topHeight;
          }
          
          if (totalHeight > 0) {
            topValue = totalHeight + 'px';
          }
          
          document.documentElement.style.setProperty('--simple-announcement-top', topValue);
          
          // Forzar position sticky SIEMPRE
          specificSection.style.setProperty('position', 'sticky', 'important');
          specificSection.style.setProperty('top', topValue, 'important');
          specificSection.style.setProperty('z-index', '52', 'important');
          specificSection.style.setProperty('width', '100%', 'important');
          specificSection.style.setProperty('left', '0', 'important');
          specificSection.style.setProperty('right', '0', 'important');
          specificSection.style.setProperty('margin', '0', 'important');
          specificSection.style.setProperty('padding', '0', 'important');
          
          // Asegurar que el contenedor padre no bloquee
          const parentSection = specificSection.closest('.shopify-section-group-header-group');
          if (parentSection) {
            parentSection.style.setProperty('overflow', 'visible', 'important');
          }
        } else {
          // Remover sticky si está deshabilitado
          specificSection.classList.remove('sticky-enabled-section');
          specificSection.style.removeProperty('position');
          specificSection.style.removeProperty('top');
          specificSection.style.removeProperty('z-index');
          specificSection.style.removeProperty('width');
          specificSection.style.removeProperty('left');
          specificSection.style.removeProperty('right');
          specificSection.style.removeProperty('margin');
          specificSection.style.removeProperty('padding');
        }
        
        // Eliminar estilos inline de background-color y color si existen
        if (specificSection.hasAttribute('data-no-inline-styles')) {
          const currentStyle = specificSection.getAttribute('style') || '';
          const newStyle = currentStyle
            .replace(/background-color\s*:\s*[^;]+;?/gi, '')
            .replace(/color\s*:\s*[^;]+;?/gi, '')
            .replace(/;\s*;/g, ';')
            .trim();
          
          if (newStyle) {
            specificSection.setAttribute('style', newStyle);
          } else if (!currentStyle.includes('--simple-announcement')) {
            specificSection.removeAttribute('style');
          }
        }
      }
      
      // Ejecutar en varios momentos
      applyStickyAndCleanStyles();
      document.addEventListener('DOMContentLoaded', applyStickyAndCleanStyles);
      window.addEventListener('load', applyStickyAndCleanStyles);
      setTimeout(applyStickyAndCleanStyles, 50);
      setTimeout(applyStickyAndCleanStyles, 100);
      setTimeout(applyStickyAndCleanStyles, 200);
      setTimeout(applyStickyAndCleanStyles, 500);
      
      // Ejecutar en scroll para mantener sticky activo
      window.addEventListener('scroll', applyStickyAndCleanStyles, { passive: true });
      
      // Ejecutar periódicamente
      setInterval(applyStickyAndCleanStyles, 100);
      
      // Observar cambios
      const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          if (mutation.type === 'attributes' && 
              (mutation.attributeName === 'style' || mutation.attributeName === 'data-sticky-enabled' || mutation.attributeName === 'class')) {
            applyStickyAndCleanStyles();
          } else if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
            applyStickyAndCleanStyles();
          }
        });
      });
      
      observer.observe(specificSection, {
        attributes: true,
        attributeFilter: ['style', 'data-sticky-enabled', 'class'],
        childList: true,
        subtree: true
      });
      
      // Observar cambios en otros elementos sticky para recalcular top
      const stickyObserver = new MutationObserver(function() {
        applyStickyAndCleanStyles();
      });
      
      const announcementBarTop = document.querySelector('.announcement-bar-top-section');
      if (announcementBarTop) {
        stickyObserver.observe(announcementBarTop, {
          attributes: true,
          attributeFilter: ['class', 'style'],
          childList: true,
          subtree: true
        });
      }
      
      // Escuchar eventos de Shopify
      if (typeof Shopify !== 'undefined') {
        document.addEventListener('shopify:section:load', function(event) {
          if (event.detail && event.detail.sectionId === sectionId.replace('shopify-section-', '')) {
            setTimeout(applyStickyAndCleanStyles, 100);
          }
        });
        document.addEventListener('shopify:section:select', function(event) {
          if (event.detail && event.detail.sectionId === sectionId.replace('shopify-section-', '')) {
            setTimeout(applyStickyAndCleanStyles, 100);
          }
        });
      }
    })();
  </script>
</div>
{%- endif -%}

{% schema %}
{
  "name": "Simple Announcement Item",
  "class": "simple-announcement-item-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "checkbox",
      "id": "enable_item",
      "label": "Enable item",
      "default": true
    },
    {
      "type": "text",
      "id": "text",
      "label": "Text",
      "default": "Fashion crafted from the finest Pima & Alpaca... and not a drop of plastic"
    },
    {
      "type": "url",
      "id": "link_url",
      "label": "Link URL"
    },
    {
      "type": "text",
      "id": "link_label",
      "label": "Link label",
      "info": "Accessibility label for the link"
    },
    {
      "type": "text",
      "id": "icon",
      "label": "Icon name",
      "info": "Icon name from the theme's icon library"
    },
    {
      "type": "header",
      "content": "Style Settings"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font size (px)",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 13
    },
    {
      "type": "header",
      "content": "Sticky Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky",
      "label": "Enable sticky",
      "default": true,
      "info": "When enabled, this item will stay fixed when scrolling"
    },
    {
      "type": "checkbox",
      "id": "sticky_on_home",
      "label": "Apply sticky on home page",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "sticky_on_collection",
      "label": "Apply sticky on collection pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "sticky_on_product",
      "label": "Apply sticky on product pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "sticky_on_blog",
      "label": "Apply sticky on blog pages",
      "default": true
    },
    {
      "type": "header",
      "content": "Visibility Settings"
    },
    {
      "type": "checkbox",
      "id": "show_on_home",
      "label": "Show on home page",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_collection",
      "label": "Show on collection pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_product",
      "label": "Show on product pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_blog",
      "label": "Show on blog pages",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Simple Announcement Item"
    }
  ],
  "enabled_on": {
    "templates": ["*"],
    "groups": ["header"]
  }
}
{% endschema %}

