{{ 'announcement-bar.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign enable_item = section.settings.enable_item
  assign text = section.settings.text
  assign link_url = section.settings.link_url
  assign link_label = section.settings.link_label
  assign icon = section.settings.icon
  
  assign show_on_home = section.settings.show_on_home
  assign show_on_collection = section.settings.show_on_collection
  assign show_on_product = section.settings.show_on_product
  assign show_on_blog = section.settings.show_on_blog
  
  assign show_item = true
  
  if show_on_home == blank
    assign show_on_home = true
  endif
  if show_on_collection == blank
    assign show_on_collection = true
  endif
  if show_on_product == blank
    assign show_on_product = true
  endif
  if show_on_blog == blank
    assign show_on_blog = true
  endif
  
  if template == 'index'
    if show_on_home == false
      assign show_item = false
    endif
  elsif template.name == 'collection'
    if show_on_collection == false
      assign show_item = false
    endif
  elsif template.name == 'product'
    if show_on_product == false
      assign show_item = false
    endif
  elsif template.name == 'blog' or template.name == 'article'
    if show_on_blog == false
      assign show_item = false
    endif
  endif
  
  assign enable_sticky = section.settings.enable_sticky
  assign sticky_on_home = section.settings.sticky_on_home
  assign sticky_on_collection = section.settings.sticky_on_collection
  assign sticky_on_product = section.settings.sticky_on_product
  assign sticky_on_blog = section.settings.sticky_on_blog
  
  if enable_sticky == blank
    assign enable_sticky = true
  endif
  
  if sticky_on_home == blank
    assign sticky_on_home = true
  endif
  if sticky_on_collection == blank
    assign sticky_on_collection = true
  endif
  if sticky_on_product == blank
    assign sticky_on_product = true
  endif
  if sticky_on_blog == blank
    assign sticky_on_blog = true
  endif
  
  if enable_sticky
    if template == 'index'
      if sticky_on_home == false
        assign enable_sticky = false
      endif
    elsif template.name == 'collection'
      if sticky_on_collection == false
        assign enable_sticky = false
      endif
    elsif template.name == 'product'
      if sticky_on_product == false
        assign enable_sticky = false
      endif
    elsif template.name == 'blog' or template.name == 'article'
      if sticky_on_blog == false
        assign enable_sticky = false
      endif
    endif
  endif
-%}

{%- liquid
  assign background_color = section.settings.background_color | default: '#000000'
  assign text_color = section.settings.text_color | default: '#ffffff'
  assign font_size = section.settings.font_size | default: 13
-%}

{%- if enable_item and show_item -%}
<div id="shopify-section-{{ section.id }}" class="simple-announcement-item-section {% if enable_sticky %}sticky-enabled-section{% endif %}" style="background-color: {{ background_color }}; color: {{ text_color }};">
  <div class="simple-announcement-item" data-sticky-enabled="{% if enable_sticky %}true{% else %}false{% endif %}">
    <div class="simple-announcement-item--inner">
      <div class="simple-announcement-item--content">
        {%- if icon != blank -%}
          {% render 'svg-icons-inline', icon: icon %}
        {%- endif -%}
        {%- if link_url != blank -%}
          <a href="{{ link_url }}" {% if link_label != blank %}aria-label="{{ link_label }}"{% endif %}>
            {{ text }}
          </a>
        {%- else -%}
          {{ text }}
        {%- endif -%}
      </div>
    </div>
  </div>
  
  <style>
    /* Estilos esenciales para simple-announcement-item */
    #shopify-section-{{ section.id }}.simple-announcement-item-section {
      margin: 0;
      padding: 0;
      border: none;
      background-color: {{ background_color }} !important;
      color: {{ text_color }} !important;
    }
    
    #shopify-section-{{ section.id }}.simple-announcement-item-section.sticky-enabled-section {
      position: sticky !important;
      top: 0 !important;
      z-index: 52 !important;
      width: 100% !important;
      left: 0 !important;
      right: 0 !important;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 42px;
      min-height: 42px;
      max-height: 42px;
      margin: 0;
      padding: 0;
      background-color: {{ background_color }} !important;
      color: {{ text_color }} !important;
    }
    
    @media (max-width: 768px) {
      #shopify-section-{{ section.id }} .simple-announcement-item {
        height: 46px;
        min-height: 46px;
        max-height: 46px;
      }
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--inner {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0 15px;
    }
    
    /* En mobile, ajustar el inner para permitir dos líneas */
    @media (max-width: 768px) {
      #shopify-section-{{ section.id }} .simple-announcement-item--inner {
        align-items: center;
        flex-wrap: wrap;
      }
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--content {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin: 0;
      padding: 0;
      font-size: {{ font_size }}px !important;
      color: {{ text_color }} !important;
    }
    
    /* En mobile, permitir que el texto pase a dos líneas */
    @media (max-width: 768px) {
      #shopify-section-{{ section.id }} .simple-announcement-item--content {
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.3;
        max-height: calc(1.3em * 2);
        word-wrap: break-word;
        word-break: break-word;
        text-align: center;
        justify-content: center;
        -webkit-box-pack: center;
      }
      
      #shopify-section-{{ section.id }} .simple-announcement-item--content a {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        white-space: normal;
        overflow: hidden;
        text-overflow: ellipsis;
        word-wrap: break-word;
        word-break: break-word;
        text-align: center;
        -webkit-box-pack: center;
      }
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--content a {
      color: {{ text_color }} !important;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--content a:hover {
      color: {{ text_color }} !important;
      text-decoration: none;
      background-color: transparent !important;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item--content svg {
      margin: 0 8px 0 0;
      flex-shrink: 0;
      height: auto;
      width: auto;
      max-height: 18px;
      max-width: 18px;
      fill: {{ text_color }} !important;
      stroke: {{ text_color }} !important;
      color: {{ text_color }} !important;
    }
    
    #shopify-section-{{ section.id }} .simple-announcement-item:hover,
    #shopify-section-{{ section.id }} .simple-announcement-item *:hover {
      transform: none !important;
      translate: none !important;
      box-shadow: none !important;
      cursor: default !important;
      background-color: {{ background_color }} !important;
      color: {{ text_color }} !important;
    }
  </style>
  
  <script>
    (function() {
      // Notificar al sistema centralizado de sticky cuando este elemento cambie
      const sectionId = 'shopify-section-{{ section.id }}';
      const section = document.getElementById(sectionId);
      
      if (section) {
        // Función para notificar cambios
        const notifyStickyChange = () => {
          window.dispatchEvent(new CustomEvent('sticky-element-changed', {
            detail: { element: section }
          }));
          if (window.themeHeader && typeof window.themeHeader.updateAllStickyElements === 'function') {
            window.themeHeader.updateAllStickyElements();
          }
        };
        
        // Notificar cuando el DOM esté listo
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', notifyStickyChange);
        } else {
          notifyStickyChange();
        }
        
        // Notificar después de delays
        setTimeout(notifyStickyChange, 50);
        setTimeout(notifyStickyChange, 100);
        setTimeout(notifyStickyChange, 200);
        
        // Notificar cuando la ventana se carga completamente
        window.addEventListener('load', notifyStickyChange);
        
        // Observar cambios en data-sticky-enabled
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'attributes' && mutation.attributeName === 'data-sticky-enabled') {
              notifyStickyChange();
            }
          });
        });
        
        const item = section.querySelector('.simple-announcement-item');
        if (item) {
          observer.observe(item, {
            attributes: true,
            attributeFilter: ['data-sticky-enabled']
          });
        }
        
        // Escuchar eventos de Shopify
        if (typeof Shopify !== 'undefined') {
          document.addEventListener('shopify:section:load', (event) => {
            if (event.detail?.sectionId === sectionId.replace('shopify-section-', '')) {
              setTimeout(notifyStickyChange, 100);
            }
          });
        }
      }
    })();
  </script>
</div>
{%- endif -%}

{% schema %}
{
  "name": "Simple Announcement Item",
  "class": "simple-announcement-item-section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "checkbox",
      "id": "enable_item",
      "label": "Enable item",
      "default": true
    },
    {
      "type": "text",
      "id": "text",
      "label": "Text",
      "default": "Fashion crafted from the finest Pima & Alpaca... and not a drop of plastic"
    },
    {
      "type": "url",
      "id": "link_url",
      "label": "Link URL"
    },
    {
      "type": "text",
      "id": "link_label",
      "label": "Link label",
      "info": "Accessibility label for the link"
    },
    {
      "type": "text",
      "id": "icon",
      "label": "Icon name",
      "info": "Icon name from the theme's icon library"
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#ffffff"
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Font size",
      "min": 10,
      "max": 24,
      "step": 1,
      "unit": "px",
      "default": 13
    },
    {
      "type": "header",
      "content": "Sticky Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_sticky",
      "label": "Enable sticky",
      "default": true,
      "info": "When enabled, this item will stay fixed when scrolling"
    },
    {
      "type": "checkbox",
      "id": "sticky_on_home",
      "label": "Apply sticky on home page",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "sticky_on_collection",
      "label": "Apply sticky on collection pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "sticky_on_product",
      "label": "Apply sticky on product pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "sticky_on_blog",
      "label": "Apply sticky on blog pages",
      "default": true
    },
    {
      "type": "header",
      "content": "Visibility Settings"
    },
    {
      "type": "checkbox",
      "id": "show_on_home",
      "label": "Show on home page",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_collection",
      "label": "Show on collection pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_product",
      "label": "Show on product pages",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_blog",
      "label": "Show on blog pages",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Simple Announcement Item"
    }
  ],
  "enabled_on": {
    "templates": ["*"],
    "groups": ["header"]
  }
}
{% endschema %}

